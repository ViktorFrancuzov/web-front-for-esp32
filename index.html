<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Реле по цене — конфиг v0.2</title>
<style>
  :root{
    --bg:#0f172a; --card:#111827; --ink:#e5e7eb; --muted:#94a3b8;
    --line:#1f2937; --accent:#22c55e; --warn:#f59e0b; --err:#ef4444;
    --input:#0b1220; --input-line:#223046;
  }
  body{margin:0;background:var(--bg);color:var(--ink);
    font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Noto Sans',Arial}
  .wrap{max-width:1000px;margin:24px auto;padding:0 16px}
  h1{margin:0 0 16px;font-size:22px}
  fieldset{background:var(--card);border:1px solid var(--line);
    border-radius:14px;padding:14px;margin:12px 0}
  legend{padding:0 8px;color:var(--muted)}
  label{color:var(--muted);font-size:13px;display:block;margin:0 0 6px}
  .row{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
  .col{flex:1 1 220px;min-width:220px}
  input,select,textarea{width:100%;background:var(--input);color:var(--ink);
    border:1px solid var(--input-line);border-radius:10px;padding:10px;font-size:14px}
  textarea{min-height:200px;font-family:ui-monospace,monospace}
  .btn{cursor:pointer;border:1px solid var(--input-line);background:var(--input);
    color:var(--ink);border-radius:10px;padding:10px 14px;font-weight:600}
  .btn.primary{background:var(--accent);color:#062413;border-color:var(--accent)}
  .btn.danger{background:var(--err);color:#fff;border-color:var(--err)}
  table{width:100%;border-spacing:0 6px}
  thead th{color:var(--muted);padding:6px 8px}
  tbody td{background:var(--card);border:1px solid var(--line);padding:8px}
  tbody tr td:first-child{border-radius:10px 0 0 10px}
  tbody tr td:last-child{border-radius:0 10px 10px 0}
  #log{margin-top:10px;white-space:pre-wrap}
</style>
</head>
<body>
<div class="wrap">
  <h1>Конфиг реле (relaycfg.json) — v0.2</h1>

  <fieldset>
    <legend>Редактор / импорт</legend>
    <div class="row">
      <input type="file" id="fileIn" accept=".json">
      <button class="btn" id="btnPaste">Вставить из буфера</button>
    </div>
    <textarea id="rawIn" placeholder="Вставьте сюда relaycfg.json или загрузите файл"></textarea>
    <div class="row">
      <button class="btn" id="btnParse">Разобрать → форму</button>
      <button class="btn danger" id="btnClear">Очистить</button>
    </div>
  </fieldset>

  <fieldset>
    <legend>Интервалы</legend>
    <table id="rangesTable">
      <thead><tr><th>День</th><th>От</th><th>До</th><th>Мин. часов</th></tr></thead>
      <tbody></tbody>
    </table>
  </fieldset>

  <fieldset>
    <legend>Предпросмотр</legend>
    <button class="btn primary" id="btnBuild">Сформировать JSON</button>
    <textarea id="rawOut"></textarea>
  </fieldset>

  <div id="log"></div>
</div>

<script>
function log(msg,err=false){
  const el=document.getElementById('log');
  el.style.color=err?'var(--err)':'var(--muted)';
  el.textContent=(err?'⚠ ':'ℹ ')+msg;
}

const state={ranges:[]};
const tbody=document.querySelector('#rangesTable tbody');

// загрузка файла
document.getElementById('fileIn').addEventListener('change',async e=>{
  const f=e.target.files[0]; if(!f) return;
  try{
    const txt=await f.text();
    document.getElementById('rawIn').value=txt;
    log('Файл загружен, нажмите «Разобрать»');
  }catch(e){log('Ошибка чтения файла: '+e,true);}
});

// вставка из буфера
document.getElementById('btnPaste').onclick=async()=>{
  try{
    const txt=await navigator.clipboard.readText();
    document.getElementById('rawIn').value=txt;
    log('Вставлено из буфера');
  }catch(e){log('Не удалось прочитать из буфера',true);}
};

// парсинг
document.getElementById('btnParse').onclick=()=>{
  const s=document.getElementById('rawIn').value.trim();
  if(!s){log('Пустое поле',true);return;}
  try{
    const j=JSON.parse(s);
    if(!j.relay){log('Нет ключа relay',true);return;}
    state.ranges=[];
    if(Array.isArray(j.relay.schedule)){
      for(const g of j.relay.schedule){
        if(!Array.isArray(g.entries)) continue;
        for(const e of g.entries){
          if(!Array.isArray(e.ranges)) continue;
          for(const r of e.ranges){
            const wd=r.from?.wd||g.wd||0;
            const from=r.from?.time||'',to=r.to?.time||'';
            const mh=r.min_hours||e.min_hours||0;
            if(wd&&from&&to) state.ranges.push({wd,from,to,min_hours:mh});
          }
        }
      }
    }
    renderRanges();
    log('JSON разобран ✔');
  }catch(e){log('Ошибка JSON: '+e.message,true);}
};

function renderRanges(){
  tbody.innerHTML='';
  const days=['Пн','Вт','Ср','Чт','Пт','Сб','Вс'];
  state.ranges.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${days[r.wd-1]||r.wd}</td><td>${r.from}</td><td>${r.to}</td><td>${r.min_hours}</td>`;
    tbody.appendChild(tr);
  });
}

// сборка
document.getElementById('btnBuild').onclick=()=>{
  try{
    const relay={mode:"schedule",schedule:[{wd:1,entries:[{mode:"schedule",ranges:state.ranges}]}]};
    const doc={relay};
    document.getElementById('rawOut').value=JSON.stringify(doc,null,2);
    log('JSON собран');
  }catch(e){log('Ошибка сборки: '+e.message,true);}
};

// очистка
document.getElementById('btnClear').onclick=()=>{
  document.getElementById('rawIn').value='';
  tbody.innerHTML='';
  state.ranges=[];
  log('Очищено');
};
</script>
</body>
</html>
