<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Реле по цене — конфиг v0.3</title>
<style>
  :root{
    --bg:#0f172a; --card:#111827; --ink:#e5e7eb; --muted:#94a3b8;
    --line:#1f2937; --accent:#22c55e; --warn:#f59e0b; --err:#ef4444;
    --input:#0b1220; --input-line:#223046;
  }
  body{margin:0;background:var(--bg);color:var(--ink);
    font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Noto Sans',Arial}
  .wrap{max-width:1000px;margin:24px auto;padding:0 16px}
  h1{margin:0 0 16px;font-size:22px}
  fieldset{background:var(--card);border:1px solid var(--line);
    border-radius:14px;padding:14px;margin:12px 0}
  legend{padding:0 8px;color:var(--muted)}
  label{color:var(--muted);font-size:13px;display:block;margin:0 0 6px}
  .row{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
  .col{flex:1 1 220px;min-width:220px}
  input,select,textarea{width:100%;background:var(--input);color:var(--ink);
    border:1px solid var(--input-line);border-radius:10px;padding:10px 12px;font-size:14px}
  textarea{min-height:200px;font-family:ui-monospace,monospace}
  .btn{cursor:pointer;border:1px solid var(--input-line);background:var(--input);
    color:var(--ink);border-radius:10px;padding:10px 14px;font-weight:600}
  .btn.primary{background:var(--accent);color:#062413;border-color:var(--accent)}
  .btn.danger{background:var(--err);color:#fff;border-color:var(--err)}
  .seg{display:inline-flex;border:1px solid var(--input-line);border-radius:10px;overflow:hidden}
  .seg button{border:0;background:transparent;padding:8px 12px;color:var(--ink);opacity:.7}
  .seg button.active{background:var(--accent);color:#062413;opacity:1}
  table{width:100%;border-collapse:separate;border-spacing:0 6px}
  thead th{color:var(--muted);font-weight:600;padding:6px 8px}
  tbody td{background:var(--card);border:1px solid var(--line);padding:8px}
  tbody tr td:first-child{border-radius:10px 0 0 10px}
  tbody tr td:last-child{border-radius:0 10px 10px 0}
</style>
</head>
<body>
<div class="wrap">
  <h1>Конфиг реле (relaycfg.json) — v0.3</h1>

  <fieldset>
    <legend>Основные</legend>
    <div class="row">
      <div class="seg" id="modeSeg">
        <button data-mode="manual">manual</button>
        <button data-mode="threshold">threshold</button>
        <button data-mode="schedule" class="active">schedule</button>
      </div>
      <div class="col" id="thresholdBox">
        <label>Threshold</label>
        <input type="number" id="threshold" step="0.01" value="120">
      </div>
      <div><label>Manual ON <input type="checkbox" id="manualState"></label></div>
      <div class="col">
        <label>Мин. часов по умолчанию</label>
        <input type="number" id="defaultMinHours" value="6">
      </div>
    </div>
  </fieldset>

  <fieldset>
    <legend>Интервалы</legend>
    <div class="row">
      <select id="wd">
        <option value="1">Пн</option><option value="2">Вт</option><option value="3">Ср</option>
        <option value="4">Чт</option><option value="5">Пт</option><option value="6">Сб</option><option value="7">Вс</option>
      </select>
      <input type="text" id="fromTime" value="11:00">
      <input type="text" id="toTime" value="20:00">
      <input type="number" id="minHours" value="6">
      <button class="btn" id="btnAddRange">Добавить</button>
    </div>
    <table><thead><tr><th>День</th><th>От</th><th>До</th><th>Мин.ч</th><th></th></tr></thead>
      <tbody id="rangesTable"></tbody></table>
  </fieldset>

  <fieldset>
    <legend>Telegram</legend>
    <label>price_multiplier <input type="number" id="priceMultiplier" value="1"></label>
    <label>price_note <input type="text" id="priceNote"></label>
  </fieldset>

  <fieldset>
    <legend>Редактор</legend>
    <input type="file" id="fileIn" accept=".json">
    <button class="btn" id="btnLoadFile">Загрузить файл</button>
    <textarea id="rawIn"></textarea>
    <button class="btn" id="btnParse">Разобрать → форму</button>
    <button class="btn danger" id="btnClear">Очистить</button>
  </fieldset>

  <fieldset>
    <legend>Выгрузка</legend>
    <button class="btn primary" id="btnBuild">Сформировать JSON</button>
    <textarea id="rawOut"></textarea>
  </fieldset>
</div>

<script>
function log(msg,err){console.log(msg);alert(msg);}
const state={mode:'schedule',threshold:120,manual_state:false,default_min_hours:6,ranges:[],price_multiplier:1,price_note:'',telegramExtra:{}};
function $(id){return document.getElementById(id);}
function renderRanges(){
  const tb=$('rangesTable');tb.innerHTML='';
  const days=['Пн','Вт','Ср','Чт','Пт','Сб','Вс'];
  state.ranges.forEach((r,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${days[r.wd-1]}</td><td>${r.from}</td><td>${r.to}</td><td>${r.min_hours}</td>
    <td><button data-i="${i}">X</button></td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('button').forEach(b=>b.onclick=()=>{state.ranges.splice(b.dataset.i,1);renderRanges();});
}
function setMode(m){state.mode=m;document.querySelectorAll('#modeSeg button').forEach(b=>b.classList.toggle('active',b.dataset.mode===m));$('thresholdBox').style.display=(m==='threshold')?'':'none';}
$('modeSeg').onclick=e=>{const b=e.target.closest('button');if(b)setMode(b.dataset.mode);}
$('threshold').oninput=()=>state.threshold=+$('threshold').value;
$('manualState').onchange=()=>state.manual_state=$('manualState').checked;
$('defaultMinHours').oninput=()=>state.default_min_hours=parseInt($('defaultMinHours').value||'0',10);
$('btnAddRange').onclick=()=>{state.ranges.push({wd:+$('wd').value,from:$('fromTime').value,to:$('toTime').value,min_hours:+$('minHours').value});renderRanges();};
$('priceMultiplier').oninput=()=>state.price_multiplier=+$('priceMultiplier').value;
$('priceNote').oninput=()=>state.price_note=$('priceNote').value;
$('btnClear').onclick=()=>$('rawIn').value='';

$('btnLoadFile').onclick=async()=>{const f=$('fileIn').files?.[0];if(!f)return;$('rawIn').value=await f.text();};

$('btnParse').onclick=()=>{
  try{const j=JSON.parse($('rawIn').value);
    setMode(j.relay?.mode||'schedule');
    state.threshold=j.relay?.threshold||0; $('threshold').value=state.threshold;
    state.manual_state=!!j.relay?.manual_state; $('manualState').checked=state.manual_state;
    state.ranges=[];
    (j.relay?.schedule||[]).forEach(g=>(g.entries||[]).forEach(e=>(e.ranges||[]).forEach(r=>{state.ranges.push({wd:r.from?.wd,from:r.from?.time,to:r.to?.time,min_hours:r.min_hours});})));
    state.price_multiplier=j.telegram?.price_multiplier||1;$('priceMultiplier').value=state.price_multiplier;
    state.price_note=j.telegram?.price_note||'';$('priceNote').value=state.price_note;
    state.telegramExtra={...j.telegram};delete state.telegramExtra.price_multiplier;delete state.telegramExtra.price_note;
    renderRanges();log('JSON разобран');
  }catch(e){log('Ошибка JSON: '+e,true);}
};

function hmToMinutes(t){const m=/^(\\d{1,2}):(\\d{2})$/.exec(t);return m?(+m[1])*60+(+m[2]):null;}
function nextWd(wd){return wd>=7?1:(wd+1);}

$('btnBuild').onclick=()=>{
  const grouped={};
  for(const r of state.ranges)(grouped[r.wd]??=[]).push(r);
  const schedule=Object.keys(grouped).map(k=>{
    const wd=+k,arr=grouped[k];
    const ranges=arr.map(x=>{
      const fm=hmToMinutes(x.from),tm=hmToMinutes(x.to);
      const toWd=(tm!=null&&fm!=null&&tm<=fm)?nextWd(x.wd):x.wd;
      return{from:{wd:x.wd,time:x.from},to:{wd:toWd,time:x.to},min_hours:x.min_hours};
    });
    return{wd,entries:[{mode:"schedule",ranges}]};
  });
  const relay={mode:state.mode,threshold:state.threshold,manual_state:state.manual_state,schedule};
  const telegram={price_multiplier:state.price_multiplier,price_note:state.price_note,...state.telegramExtra};
  $('rawOut').value=JSON.stringify({relay,telegram},null,2);
  log('JSON сформирован');
};

setMode('schedule');renderRanges();
</script>
</body>
</html>
