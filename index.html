<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Реле по цене — конфиг v0.5</title>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<style>
  :root{
    --bg:#0f172a; --card:#111827; --ink:#e5e7eb; --muted:#94a3b8;
    --line:#223046; --accent:#22c55e; --err:#ef4444;
    --input:#0b1220;
  }
  body{margin:0;background:var(--bg);color:var(--ink);
    font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Noto Sans',Arial}
  .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
  h1{margin:0 0 12px}
  fieldset{background:var(--card);border:1px solid var(--line);
    border-radius:14px;padding:14px;margin:12px 0}
  legend{padding:0 8px;color:var(--muted)}
  .row{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
  .col{flex:1 1 220px;min-width:220px}
  input,select,textarea{width:100%;background:var(--input);color:var(--ink);
    border:1px solid var(--line);border-radius:10px;padding:10px 12px}
  textarea{min-height:180px;font-family:ui-monospace,SFMono-Regular,Consolas,monospace}
  .btn{cursor:pointer;border:1px solid var(--line);background:var(--input);
    color:var(--ink);border-radius:10px;padding:10px 14px;font-weight:600}
  .btn.primary{background:var(--accent);color:#062413;border-color:var(--accent)}
  .btn.danger{background:var(--err);color:#fff;border-color:var(--err)}
  .seg{display:inline-flex;border:1px solid var(--line);border-radius:10px;overflow:hidden}
  .seg button{border:0;background:transparent;padding:8px 12px;opacity:.7;color:var(--ink)}
  .seg button.active{background:var(--accent);color:#062413;opacity:1}
  table{width:100%;border-collapse:separate;border-spacing:0 6px}
  thead th{color:var(--muted);padding:6px 8px;text-align:left}
  tbody td{background:var(--card);border:1px solid var(--line);padding:8px}
  tbody tr td:first-child{border-radius:10px 0 0 10px}
  tbody tr td:last-child{border-radius:0 10px 10px 0}
  .muted{color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <h1>Конфиг реле (relaycfg.json) — v0.4</h1>

  <fieldset>
    <legend>Основные</legend>
    <div class="row">
      <div class="seg" id="modeSeg">
        <button data-mode="manual">manual</button>
        <button data-mode="threshold">threshold</button>
        <button data-mode="schedule" class="active">schedule</button>
      </div>
      <div class="col" id="thresholdBox">
        <label>Threshold</label>
        <input type="number" id="threshold" step="0.01" value="120">
      </div>
      <div><label>Manual ON <input type="checkbox" id="manualState"></label></div>
      <div class="col">
        <label>Мин. часов по умолчанию (для новых интервалов)</label>
        <input type="number" id="defaultMinHours" value="6">
      </div>
      <div>
        <label><input type="checkbox" id="autoSpan" checked> Автопереход дня, если «to &le; from»</label>
      </div>
    </div>
  </fieldset>

  <fieldset>
    <legend>Добавить интервал</legend>
    <div class="row">
      <div>
        <label>Группа (schedule.wd)</label>
        <select id="grpWd"></select>
      </div>
      <div>
        <label>From wd</label>
        <select id="fromWd"></select>
      </div>
      <div><label>From time <input type="text" id="fromTime" value="11:00"></label></div>
      <div>
        <label>To wd</label>
        <select id="toWd"></select>
      </div>
      <div><label>To time <input type="text" id="toTime" value="20:00"></label></div>
      <div><label>min_hours <input type="number" id="minHours" value="6"></label></div>
      <button class="btn" id="btnAddRange">Добавить</button>
    </div>
    <div class="muted">Под «Группа (schedule.wd)» понимается ключ <code>wd</code> узла <code>schedule[]</code>, в котором будет лежать диапазон.</div>
  </fieldset>

  <fieldset>
    <legend>Интервалы</legend>
    <table>
      <thead>
        <tr><th>Группа</th><th>From (wd,time)</th><th>To (wd,time)</th><th>min_hours</th><th></th></tr>
      </thead>
      <tbody id="rangesTable"></tbody>
    </table>
  </fieldset>

  <fieldset>
    <legend>Telegram</legend>
    <div class="row">
      <label class="col">price_multiplier <input type="number" id="priceMultiplier" step="0.01" value="1"></label>
      <label class="col">price_note <input type="text" id="priceNote" placeholder="НДС+сети"></label>
    </div>
    <div class="muted">Прочие поля из блока <code>telegram</code> сохраняются как есть (daily_price_push и т.п.).</div>
  </fieldset>

  <fieldset>
    <legend>Редактор / импорт</legend>
    <div class="row">
      <input type="file" id="fileIn" accept=".json">
      <button class="btn" id="btnPaste">Вставить из буфера</button>
    </div>
    <textarea id="rawIn" placeholder="Вставьте сюда relaycfg.json или загрузите файл"></textarea>
    <div class="row">
      <button class="btn" id="btnParse">Разобрать → форму</button>
      <button class="btn danger" id="btnClear">Очистить</button>
    </div>
  </fieldset>

  <fieldset>
    <legend>Выгрузка</legend>
    <div class="row" style="gap:8px">
      <button class="btn primary" id="btnBuild">Сформировать JSON</button>
      <button class="btn" id="btnDownload">Скачать relaycfg.json</button>
    </div>
    <textarea id="rawOut" placeholder="Готовый relaycfg.json"></textarea>
  </fieldset>

  <div class="muted" id="log"></div>
</div>

<script>
const days = ['Пн','Вт','Ср','Чт','Пт','Сб','Вс'];
const dayOpts = Array.from({length:7}, (_,i)=>`<option value="${i+1}">${days[i]}</option>`).join('');

const state = {
  mode: 'schedule',
  threshold: 120,
  manual_state: false,
  default_min_hours: 6,
  auto_span: true,
  ranges: [],
  price_multiplier: 1,
  price_note: '',
  telegramExtra: {}
};

const $ = id => document.getElementById(id);
$('grpWd').innerHTML = dayOpts;
$('fromWd').innerHTML = dayOpts;
$('toWd').innerHTML = dayOpts;

function log(msg, isErr=false){
  const el = $('log');
  el.style.color = isErr? '#ef4444' : 'var(--muted)';
  el.textContent = (isErr? '⚠ ' : 'ℹ ') + msg;
}

function setMode(m){
  state.mode = m;
  document.querySelectorAll('#modeSeg button').forEach(b=>b.classList.toggle('active', b.dataset.mode===m));
  $('thresholdBox').style.display = (m==='threshold') ? '' : 'none';
}

$('modeSeg').addEventListener('click', e=>{
  const b = e.target.closest('button'); if(!b) return; setMode(b.dataset.mode);
});
$('threshold').oninput = ()=> state.threshold = +$('threshold').value;
$('manualState').onchange = ()=> state.manual_state = $('manualState').checked;
$('defaultMinHours').oninput = ()=> state.default_min_hours = Math.max(0, parseInt($('defaultMinHours').value||'0',10));
$('autoSpan').onchange = ()=> state.auto_span = $('autoSpan').checked;

$('priceMultiplier').oninput = ()=> state.price_multiplier = +$('priceMultiplier').value;
$('priceNote').oninput = ()=> state.price_note = $('priceNote').value;

function hmToMinutes(t){
  const m = /^(\d{1,2}):(\d{2})$/.exec(t);
  return m ? (+m[1])*60 + (+m[2]) : null;
}
function nextWd(wd){ return wd>=7 ? 1 : (wd+1); }

function renderRanges(){
  const tb = $('rangesTable'); tb.innerHTML='';
  for (let i=0; i<state.ranges.length; i++){
    const r = state.ranges[i];
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${days[r.group_wd-1]||r.group_wd}</td>
      <td>${days[r.from_wd-1]||r.from_wd} ${r.from}</td>
      <td>${days[r.to_wd-1]||r.to_wd} ${r.to}</td>
      <td>${r.min_hours}</td>
      <td><button class="btn danger" data-i="${i}">Удалить</button></td>
    `;
    tb.appendChild(tr);
  }
  tb.querySelectorAll('button[data-i]').forEach(b=>{
    b.onclick = ()=>{ state.ranges.splice(+b.dataset.i,1); renderRanges(); };
  });
}

$('btnAddRange').onclick = ()=>{
  const group_wd = +$('grpWd').value;
  const from_wd  = +$('fromWd').value;
  const to_wd    = +$('toWd').value;
  const from = ($('fromTime').value||'').trim();
  const to   = ($('toTime').value||'').trim();
  const mh   = Math.max(0, parseInt(($('minHours').value||state.default_min_hours),10));
  if (!from || !to) return log('Укажите время from/to', true);
  if (!/^\d{1,2}:\d{2}$/.test(from) || !/^\d{1,2}:\d{2}$/.test(to)) return log('Формат времени HH:MM', true);
  state.ranges.push({ group_wd, from_wd, from, to_wd, to, min_hours: mh });
  renderRanges();
  log('Интервал добавлен');
};

$('btnPaste').onclick = async ()=>{
  try{ $('rawIn').value = await navigator.clipboard.readText(); log('Вставлено из буфера'); }
  catch(e){ log('Не удалось прочитать из буфера', true); }
};
$('btnClear').onclick = ()=> { $('rawIn').value=''; log('Очищено'); };
$('fileIn').addEventListener('change', async e=>{
  const f = e.target.files[0]; if(!f) return;
  $('rawIn').value = await f.text();
  log('Файл загружен, жми «Разобрать → форму»');
});

$('btnParse').onclick = ()=>{
  const s = $('rawIn').value.trim();
  if (!s) return log('Пустой ввод', true);
  try{
    const j = JSON.parse(s);
    if (!j.relay) return log('Нет ключа relay', true);

    setMode(j.relay.mode || 'schedule');
    state.threshold = +j.relay.threshold || 0; $('threshold').value = state.threshold;
    state.manual_state = !!j.relay.manual_state; $('manualState').checked = state.manual_state;

    state.default_min_hours = j.relay.default_min_hours ?? 6;
    $('defaultMinHours').value = state.default_min_hours;
    state.auto_span = j.relay.auto_span ?? true;
    $('autoSpan').checked = state.auto_span;

    state.ranges = [];
    if (Array.isArray(j.relay.schedule)) {
      for (const g of j.relay.schedule) {
        const groupWd = +g.wd || 0;
        if (!Array.isArray(g.entries)) continue;
        for (const e of g.entries) {
          if ((e.mode||'schedule') !== 'schedule') continue;
          if (!Array.isArray(e.ranges)) continue;
          for (const r of e.ranges) {
            const from_wd = +(r.from?.wd || groupWd || 0);
            const to_wd   = +(r.to?.wd   || from_wd || 0);
            const from    = r.from?.time || '';
            const to      = r.to?.time   || '';
            const mh      = +r.min_hours || 0;
            if (groupWd && from_wd && to_wd && from && to && mh>=0) {
              state.ranges.push({ group_wd: groupWd, from_wd, from, to_wd, to, min_hours: mh });
            }
          }
        }
      }
    }

    state.telegramExtra = {};
    state.price_multiplier = +((j.telegram && j.telegram.price_multiplier)!=null ? j.telegram.price_multiplier : 1);
    state.price_note      = (j.telegram && j.telegram.price_note) || '';
    $('priceMultiplier').value = state.price_multiplier;
    $('priceNote').value = state.price_note;
    if (j.telegram) {
      for (const [k,v] of Object.entries(j.telegram)) {
        if (k==='price_multiplier' || k==='price_note') continue;
        state.telegramExtra[k] = v;
      }
    }

    renderRanges();
    log('JSON разобран ✔');
  }catch(e){ log('Ошибка JSON: '+e.message, true); }
};

$('btnBuild').onclick = ()=>{
  try{
    const grouped = {};
    for (const r of state.ranges) {
      (grouped[r.group_wd] ??= []).push(r);
    }

    const schedule = Object.keys(grouped).map(k=>{
      const groupWd = +k;
      const ranges = grouped[k].map(x=>{
        let to_wd = x.to_wd || x.from_wd;
        if (state.auto_span && x.to_wd==null) {
          const fm = hmToMinutes(x.from), tm = hmToMinutes(x.to);
          if (fm!=null && tm!=null && tm<=fm) to_wd = nextWd(x.from_wd);
        }
        return {
          from: { wd: x.from_wd, time: x.from },
          to:   { wd: to_wd,    time: x.to   },
          min_hours: x.min_hours
        };
      });
      return { wd: groupWd, entries: [{ mode: "schedule", ranges }] };
    });

    const relay = {
      mode: state.mode,
      threshold: state.threshold,
      manual_state: state.manual_state,
      default_min_hours: state.default_min_hours,
      auto_span: state.auto_span,
      schedule
    };

    const telegram = {
      ...(isFinite(state.price_multiplier) ? { price_multiplier: state.price_multiplier } : {}),
      ...(state.price_note ? { price_note: state.price_note } : {}),
      ...state.telegramExtra
    };

    const out = { relay, telegram };
    $('rawOut').value = JSON.stringify(out, null, 2);
    log('JSON сформирован ✔');
  }catch(e){ log('Ошибка сборки: '+e.message, true); }
};

$('btnDownload').onclick = ()=>{
  if (!$('rawOut').value) $('btnBuild').click();
  if (!$('rawOut').value) return;
  const blob = new Blob([$('rawOut').value], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'relaycfg.json';
  a.click();
  URL.revokeObjectURL(a.href);
};

setMode('schedule');
renderRanges();
</script>
</body>
</html>
