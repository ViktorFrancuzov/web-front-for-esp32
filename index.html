<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Реле по цене — конфиг</title>
  <style>
    body { font: 14px/1.4 system-ui, Arial, sans-serif; padding: 16px; max-width: 980px; margin: 0 auto; }
    h1 { margin: 0 0 12px; }
    fieldset { border: 1px solid #ddd; border-radius: 10px; padding: 12px; margin: 12px 0; }
    legend { padding: 0 8px; color: #666; }
    label { display: inline-block; margin: 6px 10px 6px 0; }
    input[type="number"], input[type="text"], select { padding: 6px 8px; }
    .row { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
    .btn { padding: 8px 12px; border-radius: 8px; border: 1px solid #ccc; background: #fafafa; cursor: pointer; }
    .btn.primary { background: #0ea5e9; color: #fff; border-color: #0ea5e9; }
    .btn.danger { background: #ef4444; color: #fff; border-color: #ef4444; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #eee; padding: 6px 8px; text-align: left; }
    textarea { width: 100%; min-height: 180px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .muted { color: #777; }
  </style>
</head>
<body>
  <h1>Конфиг реле (relaycfg.json)</h1>

  <fieldset>
    <legend>Загрузить/вставить текущий JSON</legend>
    <div class="row">
      <input type="file" id="fileIn" accept=".json" />
      <button class="btn" id="btnLoadFile">Загрузить в редактор</button>
      <span class="muted">или вставьте JSON ниже и нажмите «Разобрать»</span>
    </div>
    <textarea id="rawIn" placeholder='Вставьте сюда текущий relaycfg.json'></textarea>
    <div class="row">
      <button class="btn" id="btnParse">Разобрать → форму</button>
      <button class="btn danger" id="btnClear">Очистить</button>
    </div>
  </fieldset>

  <fieldset>
    <legend>Основные</legend>
    <div class="row">
      <label>Режим:
        <select id="relayMode">
          <option value="threshold">threshold</option>
          <option value="schedule">schedule</option>
          <option value="manual">manual</option>
        </select>
      </label>
      <label>Глобальный порог:
        <input type="number" id="threshold" step="0.01" value="120" />
      </label>
      <label title="Ручной режим — состояние реле (для будущего использования контроллером)">
        Ручной ON:
        <input type="checkbox" id="manualState" />
      </label>
    </div>
  </fieldset>

  <fieldset>
    <legend>Минимум часов по интервалам (вложенная схема)</legend>
    <div class="row">
      <label>День недели:
        <select id="wd">
          <option value="1">Пн</option><option value="2">Вт</option><option value="3">Ср</option>
          <option value="4">Чт</option><option value="5">Пт</option><option value="6">Сб</option><option value="7">Вс</option>
        </select>
      </label>
      <label>От (HH:MM): <input type="text" id="fromTime" value="11:00" /></label>
      <label>До (HH:MM): <input type="text" id="toTime" value="20:00" /></label>
      <label>Минимум часов: <input type="number" id="minHours" step="1" value="6" /></label>
      <button class="btn" id="btnAddRange">Добавить интервал</button>
    </div>

    <table id="rangesTable">
      <thead><tr><th>День</th><th>От</th><th>До</th><th>Мин. часов</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
  </fieldset>

  <fieldset>
    <legend>Telegram (опционально, попадёт в relaycfg.json)</legend>
    <div class="row">
      <label>price_multiplier: <input type="number" id="priceMultiplier" step="0.01" value="1" /></label>
      <label>price_note: <input type="text" id="priceNote" placeholder="НДС+сети" /></label>
    </div>
  </fieldset>

  <fieldset>
    <legend>Предпросмотр / выгрузка</legend>
    <div class="row">
      <button class="btn primary" id="btnBuild">Сформировать JSON</button>
      <button class="btn" id="btnCopy">Скопировать в буфер</button>
      <button class="btn" id="btnDownload">Скачать relaycfg.json</button>
    </div>
    <textarea id="rawOut" placeholder='Здесь появится готовый relaycfg.json' readonly></textarea>
    <div class="muted">Подсказываю: этот текст можно просто отправить боту в личку — прошивка проверит, что есть ключи <code>relay</code> и <code>schedule</code>, сохранит и применит автоматически.</div>
  </fieldset>

<script>
const state = {
  mode: 'threshold',
  threshold: 120,
  manual_state: false,
  ranges: [], // [{wd, from:"HH:MM", to:"HH:MM", min_hours}]
  price_multiplier: 1,
  price_note: ''
};

const els = {
  fileIn: fileIn,
  btnLoadFile: btnLoadFile,
  rawIn: rawIn,
  btnParse: btnParse,
  btnClear: btnClear,
  relayMode: relayMode,
  threshold: threshold,
  manualState: manualState,
  wd: wd,
  fromTime: fromTime,
  toTime: toTime,
  minHours: minHours,
  btnAddRange: btnAddRange,
  rangesTableBody: document.querySelector('#rangesTable tbody'),
  priceMultiplier: priceMultiplier,
  priceNote: priceNote,
  btnBuild: btnBuild,
  btnCopy: btnCopy,
  btnDownload: btnDownload,
  rawOut: rawOut
};

function renderRanges() {
  els.rangesTableBody.innerHTML = '';
  state.ranges.forEach((r, i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${['Пн','Вт','Ср','Чт','Пт','Сб','Вс'][r.wd-1] || r.wd}</td>
      <td>${r.from}</td>
      <td>${r.to}</td>
      <td>${r.min_hours}</td>
      <td><button class="btn danger" data-i="${i}">Удалить</button></td>`;
    els.rangesTableBody.appendChild(tr);
  });
  els.rangesTableBody.querySelectorAll('button[data-i]').forEach(b=>{
    b.onclick = () => { state.ranges.splice(+b.dataset.i,1); renderRanges(); };
  });
}

els.btnAddRange.onclick = () => {
  const r = {
    wd: +els.wd.value,
    from: (els.fromTime.value || '').trim(),
    to: (els.toTime.value || '').trim(),
    min_hours: Math.max(0, parseInt(els.minHours.value||'0',10))
  };
  if (!r.from.match(/^\d{1,2}:\d{2}$/) || !r.to.match(/^\d{1,2}:\d{2}$/) || r.min_hours<=0) {
    alert('Проверьте формат времени и минимум часов');
    return;
  }
  state.ranges.push(r);
  renderRanges();
};

els.relayMode.onchange = () => state.mode = els.relayMode.value;
els.threshold.oninput = () => state.threshold = +els.threshold.value;
els.manualState.onchange = () => state.manual_state = !!els.manualState.checked;
els.priceMultiplier.oninput = () => state.price_multiplier = +els.priceMultiplier.value;
els.priceNote.oninput = () => state.price_note = els.priceNote.value;

function buildJson() {
  // Схема под твой парсер:
  // relay.mode / relay.threshold / relay.schedule (nested), плюс telegram.*
  const grouped = {};
  for (const r of state.ranges) {
    if (!grouped[r.wd]) grouped[r.wd] = [];
    grouped[r.wd].push(r);
  }

  const relay = {
    mode: state.mode,
    threshold: state.threshold,
    manual_state: state.manual_state,
    schedule: Object.keys(grouped).map(wdStr => {
      const wd = +wdStr;
      return {
        wd,
        entries: [{
          mode: "schedule",
          min_hours: Math.max(...grouped[wd].map(x=>x.min_hours)),
          ranges: grouped[wd].map(x=>({
            from: { wd, time: x.from },
            to:   { wd, time: x.to }
          }))
        }]
      };
    })
  };

  const telegram = {};
  if (isFinite(state.price_multiplier)) telegram.price_multiplier = state.price_multiplier;
  if ((state.price_note||'').length) telegram.price_note = state.price_note;

  const doc = { relay, telegram };

  // минимальная проверка как на контроллере
  if (!doc.relay || !doc.relay.schedule) {
    alert('В JSON нет relay/schedule');
    return null;
  }
  return doc;
}

els.btnBuild.onclick = () => {
  const doc = buildJson();
  if (!doc) return;
  els.rawOut.value = JSON.stringify(doc, null, 2);
};

els.btnCopy.onclick = async () => {
  if (!els.rawOut.value) els.btnBuild.onclick();
  if (!els.rawOut.value) return;
  await navigator.clipboard.writeText(els.rawOut.value);
  alert('Скопировано в буфер. Отправьте текст боту.');
};

els.btnDownload.onclick = () => {
  if (!els.rawOut.value) els.btnBuild.onclick();
  if (!els.rawOut.value) return;
  const blob = new Blob([els.rawOut.value], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'relaycfg.json';
  a.click();
  URL.revokeObjectURL(a.href);
};

els.btnClear.onclick = () => {
  els.rawIn.value = '';
};

els.btnParse.onclick = () => {
  const s = els.rawIn.value.trim();
  if (!s) return;
  try {
    const j = JSON.parse(s);
    // relay
    if (j.relay) {
      state.mode = (j.relay.mode || 'threshold');
      state.threshold = +j.relay.threshold || 0;
      state.manual_state = !!j.relay.manual_state;
      els.relayMode.value = state.mode;
      els.threshold.value = state.threshold;
      els.manualState.checked = state.manual_state;

      // nested schedule → расплющим по дням
      state.ranges = [];
      if (Array.isArray(j.relay.schedule)) {
        for (const g of j.relay.schedule) {
          const groupWd = +g.wd || 0;
          if (!g.entries) continue;
          for (const e of g.entries) {
            const hoursMin = e.min_hours || e.hours_min || 0;
            if (!Array.isArray(e.ranges)) continue;
            for (const r of e.ranges) {
              const from = r.from?.time || '';
              const to   = r.to?.time   || '';
              const wdF  = +(r.from?.wd || groupWd || 0);
              const wdT  = +(r.to?.wd   || groupWd || 0);
              // если оба конца в один день — кладём одним интервалом
              if (wdF && wdT && wdF === wdT) {
                state.ranges.push({ wd: wdF, from, to, min_hours: +hoursMin });
              } else if (wdF) {
                // иначе всё равно добавим как [wdF]
                state.ranges.push({ wd: wdF, from, to, min_hours: +hoursMin });
              }
            }
          }
        }
      }
      renderRanges();
    }
    // telegram
    if (j.telegram) {
      state.price_multiplier = +j.telegram.price_multiplier || 1;
      state.price_note = j.telegram.price_note || '';
      els.priceMultiplier.value = state.price_multiplier;
      els.priceNote.value = state.price_note;
    }
    alert('JSON разобран в форму');
  } catch (e) {
    alert('Ошибка парсинга JSON: ' + e);
  }
};

els.btnLoadFile.onclick = async () => {
  const f = els.fileIn.files?.[0];
  if (!f) return;
  const txt = await f.text();
  els.rawIn.value = txt;
  els.btnParse.onclick();
};

// init
renderRanges();
</script>
</body>
</html>
